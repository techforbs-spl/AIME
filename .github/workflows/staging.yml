name: AIME Staging Deploy (manual)

on:
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    env:
      NODE_ENV: staging
      FEATURE_ADMIN_ONLY: "true"
      FEATURE_PARTNER: "false"
      FEATURE_MEMBERS: "false"
      FEATURE_SIGNAL_NETWORK: "false"   # DO NOT set true until Trigger Map QA = Complete

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

            # BACKEND
      - name: Install backend deps
        working-directory: server
        run: npm install

      - name: Build backend
        working-directory: server
        run: npm run build

      - name: Start backend in background
        working-directory: server
        run: |
          # start server in background and save PID
          PORT=8080 npm start > server_stdout.log 2>&1 &
          echo $! > server.pid
          # small sleep to let server boot (adjust if needed)
          sleep 3

      - name: Run backend smoke
        working-directory: server
        run: npm run smoke

      - name: Stop backend
        working-directory: server
        run: |
          kill $(cat server.pid) || true


      # FRONTEND
      - name: Install web deps
        working-directory: web
        run: npm install

      - name: Build web
        working-directory: web
        run: npm run build

      - name: Deployment complete
        run: echo "Staging build completed successfully."
